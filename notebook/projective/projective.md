# 射影变换

## 概念

### Circular point

二维射影空间中任意两个圆的交点。下面是射影坐标(x,y,w)下圆方程，该方程通过两个固定点$(1, \pm i, 0)$, 这两个点就是circular point， 是在2D世界中的点。这两个点是在无穷远处直线上的两个点，他在images空间中投影是什么？
$$
(\frac{x}{w}-a)^2 + (\frac{y}{w}-b)^2=r^2
$$

$$
(x-aw)^2 + (y-bw)^2=r^2w^2
$$

将$(1, \pm i, 0)$带入上面的公式(2)中可以发现，这两个点在所有的圆中。

针对<u>他在images空间中投影是什么？</u>，其实这里讨论的是2D条件下，图片之间的变换问题，circular point时想象出来的点，他在某些图片中可能并看不到具体的像，但是通过对图片进行投影变换，在变换后的图中会出现该点。如果把相机成像平面看成是无穷大的平面，那么cirucular point 在相机中一定时候存在像的。

### absolute conic

三维射影空间中任意两个球均会包含的交线。这是在3D空间中的曲线。该曲线是在无穷远处的平面上的一个曲线，他在images空间中投影是什么？为什么说得出其在image中的投影区域IAC，便可以得出相机标定结果。image中的像可以想象成是无穷远处的平面投影产生，absolute conic在image中的投影是IAC
$$
(x-aT)^2 + (y-bT)^2+(z-cT)^2=r^2T^2
$$
三维空间中点为$$(x,y,z,T)$$,3D空间中的conic必定经过点$$(x,y,z,0)$$,该坐标满足
$$
x^2+y^2+z^2=0, T=0
$$
由上面的方程可以看出，曲面和无穷远处的平面相交于曲线，该曲线是一个二阶曲线，$X^TCX=0$,其中 $X^T=(x,y,z)$，**$C=diag(1,1,1)$**,该二阶曲线就是absolute conic，就是空间球面和无穷远平面的交曲线。<u>虽然absolute conic是想象出来的曲线，但是其在图片中同样存在像，该像可能有实际意义，可能没有，但是其有助于我们对相机进行参数标定。</u>

#### conic 和quadrics的区别

- conic是曲线，2D空间下的概念，而qudarics是曲面，3D空间下的概念。
- conic是任意的球面和无穷远平面的交线

### 仿射变换中的dual关系

仿射变换中 点和直线之间存在一些相似的性质。

例如conic曲线有关于点和关于直线的方式。
$x^TCX=0$和$l^TC^*l=0$f分别是点和直线的conic曲线。其中$C^*=C^{-1}$

利用$C$可以计算图片中两个像点和相机中心组成射线之间的夹角。

利用$C^*$可以直接计算图片中两直线的夹角。<u>该夹角和3D中实际目标的夹角是一样的</u>。



### Fundamental matrix and camera matrix

Fundamental matrix 和camera matrix是等价关系，获取其中一个便可以获得另一个



## 不同照片之间的投影关系

当两幅照片成像时相机**中心点相同**，或者3D目标**共平面时**，3D目标在两幅照片中成的像存在相应的投影关系。

$$x = H x'$$. $$H$$是$$3\times3$$的矩阵。其它情况不存在这种对应关系。

<img src="files/1523516756326.png" style="zoom:80%" />

<img src="files/1523517070325.png" style="zoom:80%" />



### 应用例子1

![1523518596153](files\1523518596153.png)

**图a**是一个由于透视变换窗口矩形形状被破坏，**图b**是利用透视变换恢复窗口形状的例子。可以认为将图a的相机保持中心位置不变，只改变相机角度进行调整，以此恢复图a中形状存在的畸变。由于图a和b相机中心位置一致，可以利用$x=Hx'$ 模拟像素对应关系。在图b中给出窗户的正确形状，利用此得出4个对应点，获取H变换矩阵，对图a进行校正。



### 不同类型的变换

书本**2.4节**

#### 仿射变换

保持平行特征，直线特征，丢失角度。转换矩阵包括六个自由度
$$
x'  = H_Ax= \begin{vmatrix} 
A & t \\
0^T & 1 \\
\end{vmatrix}
$$

#### Projective 射影变换

保持直线特征，丢失角度、平行特征，转换矩阵具有八个自由度，因为参数的比例具有意义。

#### 不同变换保留的性质

![1523519236852](files\1523519236852.png)

### 应用例子2

* 利用无穷远处直线性质，恢复原始图片部分特征

从一般射影变换到仿射变换。从图片中找到无穷远直线的投影，利用投影变换恢复投影后的直线到无穷远处，通过该变换恢复图片在仿射变换中应该存在的性质。

<u>仿射变换能够使无穷远处的直线，仍然存在无穷远处</u>

![1523519708354](files\1523519708354.png)

* 利用角度信息恢复特征

  **文中2.7部分**

<u>利用垂直性质，从仿射变换中恢复真实角度，长度比例信息。</u>

利用conic 对成像图片中线段角度进行度量。利用直角关系恢复投影矩阵，从而恢复原图进过similar变换后的结果。（保留长度比例，角度信息）

![1523520141017](files\1523520141017.png)

利用conic在成像后的图片中获取线段在3D空间中真实角度关系。l和m是成像图片中直线。

![1523520251462](files\1523520251462.png)

投影图片中，conic曲线和原图片关系如下。利用垂直直线，可以求解获取k矩阵（取v=0）k矩阵是仿射变换部分，v矩阵是射影变换部分

![1523520330342](files\1523520330342.png)

一般射影矩阵可以分解如下。

![1523520364793](files\1523520364793.png)



## 3D空间投影到2D空间

下面相机内参与理想CCD摄像机相比存在一个s。这是考虑到CCD摄像机可能存在成像时的x，y方向不严格垂直的情况。比如<u>相机光轴和成像平面不严格垂直</u>时，便会产生这种情况。

![1523520514113](files\1523520514113.png)

在该情况下，转换矩阵一共有11个自由度。K: 5, R: 3,C: 3。此时与一般转换矩阵$3\times4$，具有相同大小的自由度。$M=KR$,非奇异的时候，成为<u>finite projective cameras</u>.
$$
P=KR[I|-\widetilde{C}]
$$

$$
P = M[I|M^{-1}P_4]=KR[I|-\widetilde{C}]
$$

### 投影矩阵参数具体物理意义

![1523521105834](files\1523521105834.png)




![1523521157199](files\1523521157199.png)

#### 相机中心在图片中的成像

**书6.2节**

####相机中心点在图片中的投影

相机中心经过投影矩阵在图片中所成像是$(0,0,0)$, 因为将相机中心3D世界坐标$(C,1)$带入到转换矩阵$P=[M|P_4]=KR[I|-\widetilde{C}]$中得出投影坐标为(0,0,0)。

![1523521396874](files\1523521396874.png)

![1523521431891](files\1523521431891.png)

在$PC=0$的条件下，由前面两个公式可知经过相机中心C和另一点A的射线在相机中成像于同一点，这个符合C是相机中心的现象。

#### 矩阵P列向量物理意义

投影矩阵P中前三个列向量，是世界坐标系三个坐标轴方向的消失点(vanishing point)。世界坐标系x,y,z方向向量分别是(1,0,0,0),(0,1,0,0)(0,0,1,0). 第4列$P_4$是世界坐标系原点(0,0,0,1)在图像中所成的像.

**什么是vanishing point**？

![1523522464550](files\1523522464550.png)

#### 矩阵P行向量物理意义

投影矩阵P中三个行向量，对应了相机三个方向平面，其中$P_3$是主平面，垂直于相机坐标系的z轴，$P_2$是在过相机中心和成像坐标系x轴的平面。$PX=(*,0,1)$, 空间点X在相机中的像，其y坐标始终为0， 要求$P_2X=0$, 则X在法向量为$P_2$的平面上，该平面过相机中心和成像坐标系x轴。同理得出$P_1$是过相机中心和成像坐标系y轴的平面。因为$PC=0$，所以相机中心点，同时存在前面提到的三个平面中.

![1523523465522](files\1523523465522.png)

#### 由一个成像点，确定3D空间射线方向

**文章6.2.2**

已知空间中一个成像点，可以确定一条射线。首先，相机中心在世界坐标系中的坐标可以得出为C。再需要给出一个在射线中的点即可确定该射线的方向。C是相机中心在世界坐标系中的坐标$PC=0$,$P^+$是投影矩阵P的伪逆。

![1523523738415](files\1523523738415.png)

<u>上面公式为什么可以表示过两个点的射线？过两点A，C的直线不是用下面的方程表示的吗？</u>
$$
(1-\lambda)A+\lambda C
$$
**原因如下：**
$$
P\cdot X(\lambda)=P(P^+x+\lambda C)=PP^+x +\lambda PC=x
$$
从上面的公式可以看出射线$X(\lambda)$在相机中的所成的像的确就是想点x，这一点验证了$X(\lambda)$的确就是像点x对应的射线。如果采用一般的形式$(1-\lambda)A+\lambda C$,则$P((1-\lambda)A+\lambda C))=(1-\lambda)PA=(1-\lambda)x$,由于x是homogeneous 坐标，尺度系数$(1-\lambda)$没有意义, 所以其仍是投影为x的射线。这两者表达是一致的。

当$P=[M|P_4]$中$M$是非奇异时，像点x对应的摄像还可以有另一种更具体的表达。$\widetilde{C}=-M^{-1}P_4$.过像点x的射线与无穷远处平面交点为$X_0^T=[x_0^T|0]$,则
$$
PX_0=Mx_0=x
$$
得出$x_0=M^{-1}x$,最终射线表达如下。

![1523532240461](files\1523532240461.png)

### cameras at infinity

无穷远处的摄像机是指$P=[M|P_4]$ 中$M$是奇异的，其相机中心在无穷远处。$P$中最后一行是(0,0,0,1)时称为affine camera，原因是<u>无穷远处的点经过投影后仍然在无穷远处</u>

## 从2D空间恢复3D信息

### 相机中心点不同的图片才会包含3D信息

当多张图片是同一个相机在相同相机中心位置，通过改变**焦距**、**朝向**获取的时候，多张图片是等价关系，可以通过$3\times 3$的变换矩阵相互转换。从这些图片中是<u>无法恢复3D信息的</u>。

原因如下：

![1523589909410](files\1523589909410.png)

3D场景中同一个目标在不同图片中可以生成的不同的像，但是这些<u>像对应的射线相交于摄像机中心，而不是相交于3D空间中一个点</u>，所以其无法包含有效的3D信息。

![1523590136249](files\1523590136249.png)

当相机中心位置不同时，3D空间中同一个目标在不同相机中成的<u>像对应的射线才会在3D空间中相交，从而可以确定目标在3D空间中的位置信息</u>。

### 恢复射线方向

![1523598348988](files\1523598348988.png)

这里在相机坐标系下进行讨论

假设空间一点d，其在相机中投影为x，则过相机中心和点d的射线为$\widetilde{X}=\lambda d$.其在相机坐标系下的投影为$x=K[I|0][\lambda d^T,1]^T$不考虑尺度其方向$d=K^{-1}x$，该方向是相机坐标系下的度量。

图中两个像点$x_1$和$x_2$对应射线角度为

![1523598915948](files\1523598915948.png)

可以看出，通过两个像点便可以，得出3D空间中两个射线的夹角。<u>该夹角只与相机内参K有关</u>，通过该特点可以对相机内参进行标定。

### absolute conic 在相机中的成像

#### 无穷远平面在相机中成像

扩展坐标最后一维为0便是无穷远点、直线、或者平面。这些点均是想象出来的，<u>但是其能够很好的对计算结果做出直观的解释</u>，所以他们也很重要。

##### 理解一点

<u>现实中的场景也可以认为是一幅照片</u>，相机拍照产生的图片和原始场景之间也是一张投影变换。当场景就是一幅平面时，拍照的过程和两幅图片之间的转换关系是等价的。两者转换矩阵均是$3\times 3$。当场景看做是一幅图片时，其像素坐标关系，可以按照我们的需求来定。这一点就很方便了，可以很容易得到场景和图像之间的对应点，从而得出转换矩阵H的具体数值。相机成像平面和现实场景一样均是一张无穷大的空间，<u>不要将相机成像平面和现实中CCD成像相等价</u>。

![1523599648258](files\1523599648258.png)

其中d是无穷远处点在3D空间中坐标。可以看出无穷远处平面在相机中成像只与相机内参、相机坐标系相对于绝对坐标的旋转角度有关。

#### absolute conic 在相机中成像 

在3D空间中absolute conic的方程式已知的，其二阶曲线矩阵$C=I$，见"absolute conic"章节。由于absolute conic是在无穷远处，所以可以直接使用上面的公式，得到absolute conic在相机中所成的像，该像只与相机内参和转向角度有关。absolute conic在图像中所成像的二阶曲线矩阵$\omega = (KR)^{-T}I(KR)^{-1}=(KK^T)^{-1}$.

结合两摄像机之间夹角公式，可以得出两射线之间夹角只与absolute conic在图像中所成的像$\omega$有关。

![1523605562052](files\1523605562052.png)

#### 应用例子

![1523607183247](files\1523607183247.png)

利用图a，对相机内参K进行标定。

<u>利用空间中平面和absolute conic均会存在两个交点circular point</u>，并且该交点在平面中坐标为$(1, \pm i, 0)$,将不同平面的circular 变换到图a中，获得3D空间absolute conic在图a中的投影点，再利用二阶曲线性质，获取$\omega$的具体数值。

#####主要原理：

利用图像中目标在3D空间中已知性质，获取absolute conic相关信息。最终在图a中对absolute conic信息进行汇总，获取absolute conic $\omega$参数信息。

##### 具体步骤

1. 图a中3个不同显示器中，每个显示器在其所在平面中4个角点的坐标分别是$(0,0)^T, (0,1)^T, (1, 0)^T, (1,1)^T$,再得出4个角点在图q中坐标信息，由此4个点对应关系，获取该显示器所在平面和图a所成像之间的转换关系H。

2. 对三个显示器分别得出其与图a的转换关系，将显示器所在平面中circular point $(1, \pm i, 0)$投影到图a平面中，得出3D空间中absolute point在图a中所成的像。

3. 根据absolute point在图a中所成的像，利用二阶曲线关系方程$x^T\omega x=0$获取$\omega$具体数值。

### 消失点

   射线无穷远处的点在相机中所成的像。下图中X轴上的点，在无穷远处会和直线CD重合，其在相机中所成的像为消失点$v'$。消失点的坐标只与射线方向有关，与射线位置无关。因为无穷远处的点和相机中心的连线就是过相机中心和射线平行的直线，这个对任意平行的直线均是如此，所以平行射线对应的消失点也一样。

![1523614015335](files\1523614015335.png)

#### 直线与无穷远处平面交点就是直线方向

一个直线$A+\lambda D$,其中$A^T=(a_1, b_1, c_1,01)$是3D空间中一点，$D^T=(d1,d2,d3,0)$是直线方向。
$$
A^T+\lambda D^T = (a_1+\lambda d_1, a_2+\lambda d_2, a_3+\lambda d_3, 1)
$$

$$
(a_1+\lambda d_1, a_2+\lambda d_2, a_3+\lambda d_3, 1)=(\frac{a_1+\lambda d_1}{\lambda}, \frac{a_2+\lambda d_2}{\lambda},\frac{a_3+\lambda d_3}{\lambda},\frac{1}{\lambda} )
$$



对$\lambda$取极限，得出无穷远处坐标为
$$
(d_1,d_2,d_3,0)
$$
可以看出具有一定方向的射线在无穷远处交于无穷远处平面与公式(13)

其前三维就是射线在3D空间中的方向向量。

#### 消失点的计算

假设相机投影矩阵$P=[M|P_4]=KR[I|,\widetilde{C}]$,射线在无穷远处的点为$(d_1,d_2,d_3,0)$,其在相机中所成像为
$$
x=PD=M\widetilde{d}
$$

#### 利用几何关系获取消失点

![1523881855690](files\1523881855690.png)

空间中平行直线在图片中通过延长线得到消失点。